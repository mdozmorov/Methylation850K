---
title: "Differential Methylation"
author: "Lucas Rizkalla"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
  html_document:
    theme: cerulean
    toc: yes
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up the environment
library(knitr)
opts_chunk$set(cache.path='cache/', fig.path='img/', cache=F, tidy=T, fig.keep='high', echo=F, dpi=100, warnings=F, message=F, comment=NA, warning=F, results='as.is', fig.width = 10, fig.height = 6) #out.width=700, 
library(pander)
panderOptions('table.split.table', Inf)
set.seed(1)
library(dplyr)
options(stringsAsFactors = FALSE)
```

```{r libraries}
library (RnBeads)
library(writexl)
```

```{r settings}
# Lucas's path
data.dir           = "/Users/lucasrizkalla/Desktop/Methylation Research-VCU/Methylation850K/data"
# Mikhail's path
# data.dir           = "/Users/mdozmorov/Documents/Data/VCU_work/Lathika"

runImport = FALSE
idat.dir           = file.path(data.dir, "idats")
sample.annot.abrev = file.path(data.dir, "Sample_Annot_Abrev.csv" )

fileNameOut1       = file.path(data.dir, "Differential_Methylation.xlsx")
```

# Data Import, QC, Preprocessing, and Norm

```{r}
filename = file.path(data.dir, "preprocessed_data.Rdata")
  
if (runImport) {
  logger.start(fname=NA)
  data.source <- c(idat.dir, sample.annot.abrev)
  rnb.options(inference.age.column="Age")
  
  rnb.set <- rnb.execute.import(data.source=data.source,
                                data.type="idat.dir")
  
  report.dir = file.path(data.dir, "AgeReport")
  rnb.run.qc(rnb.set, report.dir)
  
  rnb.set.unfiltered <- rnb.set
  result <- rnb.run.preprocessing(rnb.set, dir.reports=report.dir)
  rnb.set.norm <- result$rnb.set
  save(list = c("rnb.set.norm"), file = filename)
} else {
  load(file = filename)
}

```

# Pairwise Analysis

```{r}
rnb.options("differential.comparison.columns"=c("Visit"),"columns.pairing"=c("Visit"="ID"))
rnb.options("covariate.adjustment.columns"=c("Race", "Age"))

diffMeth <- rnb.execute.computeDiffMeth(rnb.set.norm, pheno.cols = "Visit")
comparison <- get.comparisons(diffMeth)[1]

tab.sites <- get.table(diffMeth, comparison, "sites", return.data.frame = TRUE)
tab.cpgislands <- get.table(diffMeth, comparison, "cpgislands", return.data.frame = TRUE)
tab.promoters <- get.table(diffMeth, comparison, "promoters", return.data.frame = TRUE)
tab.genes <- get.table(diffMeth, comparison, "genes", return.data.frame = TRUE)

# Save all results
# Note the full results make ~200Mb xlsx
x <- list(tab.sites, tab.cpgislands, tab.promoters, tab.genes)
write_xlsx(x, path = fileNameOut1)
```


```{r session_info}
xfun::session_info()
```
